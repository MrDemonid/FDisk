# Немного теории.

## Минимальный размер создаваемого логического диска.

Размер создаваемых логических дисков, которые впоследствии используются под CP/M, напрямую
зависит от геометрии диска, выраженной в C/H/S.  
Новый диск всегда начинается с нового цилиндра (cylinder). То есть, если
предыдущий диск закончился на cylinder = 5, то новый начнется с cylinder = 6, heads (головки) = 0 и
сектор (sector) = 1.
Таким образом, минимальный размер логического диска равен размеру
одного цилиндра, т.е.:  
cylinder = heads * sectors * 512  
где: 512 - это размер сектора в байтах.  

Проблема в том, что подключенные через кардридер устройства, включая CF,
не умеют эмулировать ATA API, из-за чего Windows подбирает `фиктивную` геометрию диска,
по нехитрой формуле:  
heads = 255  
sectors = 63  
cylinders = <размер_диска_в_байтах> / (heads * sectors * 512)  

Таким образом, минимальный размер создаваемого логического диска
равен 1 цилиндру:  
heads * sectors * 512 = примерно 7.8 Мб.

Например, CF размером в 126091264 байт выдаст геометрию:  
heads = 255  
sectors = 63  
cylinders = 126091264 / (255 * 63 * 512) = 15  
т.е. **C/H/S = 15/255/63** и размер минимального логического диска в 8225280 байт, или 
около 7.8 Мб.


## Решение проблемы.

В INI-файле можно задать свои настройки C/H/S для любого диска. Если мы хотим обеспечить
совместимость со старыми DOS (младше 7.0), то берем их с BIOS старых PC. Если нам совместимость
не требуется, то подбираем сами, исходя из того, что сам FDisk может обеспечить минимум
в 1 Мб.

Поэтому, после подключения кардридера, запускаем из cmd.exe: 
```shell
wmic diskdrive get Index,Model,Size
```
И получаем размер диска в байтах:
```shell
Index  Model                                Size                                                                
1      ST3500418AS                          500105249280                                                        
0      SSD 512G                             512105932800                                                        
2      FNK TECH USB CARD READER USB Device  123379200                                                           
```
Размер в 99.99% случаев будет отличаться от размера на этикетке CF в меньшую сторону. 
Проблема известна еще с 80-х, когда производители  жёстких дисков стали считать 1 Кб не 1024 байта, 
а ровно 1000, ведь так размер диска выглядел побольше и можно было продать подороже.

Теперь высчитываем геометрию:  
heads = 16 (стандартно для дисков до 512 Мб)  
sectors = 63  
cylinders = 123379200 / (16 * 63 * 512) = 239  

Осталось только прописать эту геометрию в INI-файл:
```shell
DRIVE=3-0239-016-63
```
Здесь `3` - это номер диска. Лучше всего его посмотреть после запуска FDisk, в меню 
`5.  Change current fixed disk drive`.  
Примечание: у этого параметра под геометрию отводится четыре символа для цилиндра, три для головок и два под сектора.
Поэтому, если число меньше заданного размера, то начало забиваем нулями!

Теперь можно запускать FDisk и разбивать диск на разделы и логические диски, с минимальным
размером логического диска в 1 Мб.


## Пример.

CF имеет размер в 123379200 байт. Назначаем ему геометрию 
```shell
DRIVE=3-0239-016-63
```

Разбиваем раздел на диски:
```shell
                     Display / Modify partition information

   Drv Volume Label  Mbytes System   Usage
   D:                     1 FAT12       1%
   E:                     1 FAT12       1%
   F:                     2 FAT12       2%
   G:                     2 FAT12       2%
   H:                     3 FAT12       4%
   I:                     3 FAT12       4%
   J:                     4 FAT12       5%
   K:                     4 FAT12       5%
   L:                     8 FAT12      10%
   M:                     8 FAT12      10%
   N:                     8 FAT12      10%
   O:                     8 FAT12      10%
   P:                    30 FAT16      36%

    Total Extended Partition size is 84 Mbytes (1 Mbyte = 1048576 bytes)        
```

Проверяем:
```shell
D:\>FDisk.exe 3 /INFO
```
Получим:
```shell
Current fixed disk drive: 3   240912 sectors, geometry 239/016/63

Partition   Status   Mbytes   System           Usage    Start CHS       End CHS
 C: 1   6      A         40   FAT-16             34%     0/001/01     81/015/63
    2   5                77   Extended           66%    82/000/01    238/015/63

Largest continuous free space for primary partition = 0 MBytes

Contents of Extended DOS Partition:
Drv Volume Label  Mbytes  System          Usage    Start CHS       End CHS
 D:                    1  FAT-12             2%    82/001/01     84/015/63
 E:                    1  FAT-12             2%    85/001/01     87/015/63
 F:                    2  FAT-12             3%    88/001/01     92/015/63
 G:                    2  FAT-12             3%    93/001/01     97/015/63
 H:                    3  FAT-12             4%    98/001/01    104/015/63
 I:                    3  FAT-12             4%   105/001/01    111/015/63
 J:                    4  FAT-12             6%   112/001/01    120/015/63
 K:                    4  FAT-12             6%   121/001/01    129/015/63
 L:                    8  FAT-12            11%   130/001/01    146/015/63
 M:                    8  FAT-12            11%   147/001/01    163/015/63
 N:                    8  FAT-12            11%   164/001/01    180/015/63
 O:                    8  FAT-12            11%   181/001/01    197/015/63
 P:                   20  FAT-16 <32M       26%   198/001/01    238/015/63

Largest continuous free space in extended partition = 0 MBytes


Press any key to continue    

```
При таких параметрах CHS минимальный размер равен heads * sectors = 16*63*512 = 516096 байт.

Но, поскольку FDisk нарезает в мегабайтах, то он подгоняет минимальный размер под ближайшее
целое, чтобы диск начинался с нового цилиндра, а заканчивался на последних головке и секторе.  
Подсчитать реальные размеры можно по нехитрой формуле:
LBA = (C * heads + H) * sectors + (S - 1)  
где:
- C - текущий цилиндр (нумерация от 0)
- H - текущая головка (нумерация от 0)
- S - текущий сектор (нумерация от 1)
- heads - общее количество головок (мы задали 16)
- sectors - общее количество секторов (мы задали 63)

Получив начальный и конечный абсолютные LBA-сектора, мы легко получаем размер:  
size = (start_lba - end_lba + 1) * 512

В итоге, реальные размеры будут равны:  
D, E: 1516032 байт  
F, G: 2548224 байт  
H, I: 3580416 байт  
J, K: 4612608 байт  
L, M, N, O: 8741376 байт  

Из этого несложно сделать выводы, что уменьшая количество головок или секторов мы можем варьировать
точностью получаемых реальных размеров.

## Образы дисков в файлах

Вместо дисков программе можно подсунуть файл, с которым она будет работать как с физическим носителем.
Это может быть образ с реального диска, снятый с помощью `HDDRawCopy`, или аналогичной программы, либо
просто созданный с нуля файл. Для него высчитываем геометрию, по методике выше, и подключаем
в программу:
```shell
FDisk /IMAGE:"G:\program files\cf.cpm",243,16,63
```
Если путь к файлу содержит пробелы, то обязательно заключаем его в кавычки, как в примере, иначе
можно обойтись и без них.

Далее, работаем с образом как с простым физическим носителем и по завершении можем либо записать его
на физический носитель, или подключить к эмулятору. Собственно ради последнего эта возможность и была
добавлена в программу.
